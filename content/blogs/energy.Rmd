---
title: "Renewable energy production"
output:
  html_document:
    theme: flatly
    highlight: zenburn
    number_sections: yes
    toc: yes
    toc_float: yes
    code_folding: show
editor_options: 
  markdown: 
    wrap: 72
---


```{r, setup, include=FALSE}
knitr::opts_chunk$set(
  message = FALSE, 
  warning = FALSE, 
  tidy=FALSE,     # display code as typed
  size="small")   # slightly smaller font for code
options(digits = 3)

# default figure size
knitr::opts_chunk$set(
  fig.width=6.75, 
  fig.height=6.75,
  fig.align = "center"
)
```

```{r load-libraries, include=FALSE}
library(tidyverse)  # Load ggplot2, dplyr, and all the other tidyverse packages
library(mosaic)
library(ggthemes)
library(lubridate)
library(here)
library(skimr)
library(janitor)
library(httr)
library(readxl)
library(vroom)
library(wbstats)
library(countrycode)
library(patchwork)
library(gganimate)
library(infer)
```

```{r,load_technology_data}

technology <- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2022/2022-07-19/technology.csv')

#get all technologies
labels <- technology %>% 
  distinct(variable, label)

# Get country names using 'countrycode' package
technology <- technology %>% 
  filter(iso3c != "XCD") %>% 
  mutate(iso3c = recode(iso3c, "ROM" = "ROU"),
         country = countrycode(iso3c, origin = "iso3c", destination = "country.name"),
         country = case_when(
           iso3c == "ANT" ~ "Netherlands Antilles",
           iso3c == "CSK" ~ "Czechoslovakia",
           iso3c == "XKX" ~ "Kosovo",
           TRUE           ~ country))

#make smaller dataframe on energy
energy <- technology %>% 
  filter(category == "Energy")

# download CO2 per capita from World Bank using {wbstats} package
# https://data.worldbank.org/indicator/EN.ATM.CO2E.PC
co2_percap <- wb_data(country = "countries_only", 
                      indicator = "EN.ATM.CO2E.PC", 
                      start_date = 1970, 
                      end_date = 2022,
                      return_wide=FALSE) %>% 
  filter(!is.na(value)) %>% 
  #drop unwanted variables
  select(-c(unit, obs_status, footnote, last_updated))

# get a list of countries and their characteristics
# we just want to get the region a country is in and its income level
countries <-  wb_cachelist$countries %>% 
  select(iso3c,region,income_level)
```

```{r min-max_renewables-old, echo=FALSE, out.width="100%"}
# knitr::include_graphics(here::here("images", "renewables.png"), error = FALSE)
```

```{r min-max_renewables, echo=FALSE, out.width="100%"}
energy %>% 
  select(-iso3c, -label, -category, -group) %>% 
  pivot_wider(names_from = variable, values_from = value) %>% 
  mutate(prop_renewable = (
    elec_hydro+elec_solar+elec_wind+elec_renew_other)/elecprod
    ) -> energy_pv

library(patchwork)

plot_1 <- energy_pv %>% 
  filter(year==2019) %>%
  slice_max(n=20, prop_renewable) %>% 
  mutate(country = fct_reorder(country,prop_renewable)) %>% 
  ggplot(aes(x=country, y=prop_renewable)) +
  geom_col(fill="#001461") +
  coord_flip() + 
  labs(x=NULL,y=NULL) +
  theme_minimal()

plot_2 <- energy_pv %>% 
  filter(year==2019, prop_renewable != 0) %>%
  slice_min(n=20, prop_renewable) %>% 
  mutate(country = fct_reorder(country,prop_renewable)) %>% 
  ggplot(aes(x=country, y=prop_renewable)) +
  geom_col(fill="#001461") +
  coord_flip() +
  labs(x=NULL,y=NULL) +
  theme_minimal()

patchwork::wrap_plots(plot_1 + plot_2) +
  plot_annotation(
    title="Highest and lowest % of renewables in energy production",
    subtitle="2019 data",
    caption="Source: NBER CHAT Database"
  )
```

As the % of energy generated by renewables goes up, do CO2 per capita
emissions seem to go down?

```{r animation, echo=FALSE, out.width="100%"}
# knitr::include_graphics(here::here("images", "animation.gif"), error = FALSE)
```

      labs(title = 'Year: {frame_time}', 
           x = '% renewables', 
           y = 'CO2 per cap') +
      transition_time(year) +
      ease_aes('linear')

```{r}
energy %>% 
  select(-label, -category, -group) %>% 
  pivot_wider(names_from = variable, values_from = value) %>% 
  mutate(prop_renewable = (
    elec_hydro+elec_solar+elec_wind+elec_renew_other)/elecprod
    ) %>% 
  select(iso3c, country, year, prop_renewable) %>% 
  left_join(countries, by="iso3c") %>% 
  left_join(
    co2_percap %>% select(iso3c, date, value), 
    by=c("iso3c" = "iso3c", "year" = "date")
  ) %>% 
  na.omit() -> all_elec_data

all_elec_data %>% 
  ggplot(aes(x=prop_renewable, y=value)) +
  geom_point(aes(color=income_level)) +
  facet_wrap(~income_level) +
  labs(
    title="Year: {as.integer(frame_time)}",
    x = "% renewables",
    y = "CO2 per cap"
  ) + 
  theme_minimal() +
  theme(legend.position = "none") +
  transition_time(year) +
  view_follow(fixed_y = TRUE) +
  ease_aes('linear') -> anim_plot

animate(anim_plot)
```

> Looking at this visualisation it seems there is no correlation between
> two variables. The CO2 per capita does not seem to go down as the
> percentage of renewables go up. For most of the countries the CO2 per
> capita stays the same, while % of renewables change. However, it is
> difficult to determine if the statement is true or false just looking
> at the animation without running proper tests.
